generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Lead {
  id        String   @id @default(cuid())
  name      String

  // Social Presence - all the doorways to connection
  telegram  String?
  twitter   String?  // X/Twitter
  farcaster String?
  tiktok    String?
  youtube   String?
  twitch    String?
  instagram String?
  email     String?

  // Ownership & Status
  assigneeId String?
  assignee   TeamMember? @relation(fields: [assigneeId], references: [id])
  stage      String      @default("NEW")
  archived   Boolean     @default(false)  // Hide from main Kanban
  archivedAt DateTime?   // When was it archived?
  
  // Scoring
  score      Int         @default(0)      // Lead score (0-100)
  isHot      Boolean     @default(false)  // Manually marked as hot lead
  
  // Source tracking
  source     String?     // Where did this lead come from?

  // Tags
  tags      Tag[]       @relation("LeadTags")

  // History
  notes     Note[]
  reminders Reminder[]
  activities Activity[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TeamMember {
  id         String   @id @default(cuid())
  name       String
  email      String   @unique
  leads      Lead[]
  notes      Note[]
  activities Activity[]
  createdAt  DateTime @default(now())
}

model Note {
  id        String     @id @default(cuid())
  content   String
  leadId    String
  lead      Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  authorId  String
  author    TeamMember @relation(fields: [authorId], references: [id])
  createdAt DateTime   @default(now())
}

model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  color     String   @default("#6366f1") // Default indigo color
  leads     Lead[]   @relation("LeadTags")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Reminder {
  id          String    @id @default(cuid())
  leadId      String
  lead        Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  dueAt       DateTime
  note        String?
  completed   Boolean   @default(false)
  completedAt DateTime?
  notified    Boolean   @default(false) // Has notification been sent?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Notification settings for reminder delivery
model NotificationSettings {
  id              String   @id @default(cuid())
  
  // Email settings
  emailEnabled    Boolean  @default(false)
  emailAddress    String?
  
  // Telegram settings
  telegramEnabled Boolean  @default(false)
  telegramChatId  String?
  telegramBotToken String?
  
  // Slack settings
  slackEnabled    Boolean  @default(false)
  slackWebhookUrl String?
  slackChannel    String?
  
  // Timing
  reminderMinutesBefore Int @default(30) // How many minutes before due time to notify
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Closed deals / Contracts with trading communities
model Deal {
  id                String   @id @default(cuid())
  
  // Basic info
  communityName     String   // Trading community name
  contactUsername   String?  // Contact point username
  contactPlatform   String?  // telegram, discord, twitter, etc.
  
  // Financial terms
  fee               Decimal? @db.Decimal(18, 2)  // Fee amount
  referralCode      String?  // Their referral code
  referralRevShare  Decimal? @db.Decimal(5, 2)   // Referral revenue share %
  
  // Token allocations
  advisorTokenTotal     Decimal? @db.Decimal(18, 2)  // Advisor token total $$
  advisorVestingSchedule String?  // e.g., "12 months linear", "6 month cliff + 24 months"
  homeTokenAllocation   Decimal? @db.Decimal(5, 2)   // Home token allocation %
  homeTokenThreshold    String?  // Threshold unlock conditions
  
  // Volume info
  purportedVolume       String?  // Monthly or annual volume (text for flexibility)
  volumePeriod          String?  // "monthly" or "annual"
  
  // Contract details
  contractLink      String?    // Link to the contract document
  executedDate      DateTime?  // When the deal was signed
  status            String     @default("ACTIVE") // ACTIVE, PAUSED, TERMINATED
  notes             String?    // General notes
  
  // Payment tracking
  nextPaymentDue    DateTime?  // When is next payment due
  paymentFrequency  String?    // monthly, quarterly, etc.
  
  // Reminders
  reminders         DealReminder[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DealReminder {
  id          String    @id @default(cuid())
  dealId      String
  deal        Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  dueAt       DateTime
  note        String?
  type        String    @default("PAYMENT") // PAYMENT, VESTING, REVIEW, OTHER
  completed   Boolean   @default(false)
  completedAt DateTime?
  notified    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Activity log for tracking all lead interactions
model Activity {
  id          String    @id @default(cuid())
  leadId      String
  lead        Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type        String    // CALL, EMAIL, NOTE, STAGE_CHANGE, ASSIGNMENT, LEFT_VM, NO_ANSWER, MEETING, FOLLOW_UP
  description String?   // Optional description
  metadata    String?   // JSON string for extra data (e.g., old/new stage)
  authorId    String?
  author      TeamMember? @relation(fields: [authorId], references: [id])
  createdAt   DateTime  @default(now())
}

// Custom pipeline stages
model PipelineStage {
  id        String   @id @default(cuid())
  name      String   // Display name (e.g., "New Lead")
  key       String   @unique // Internal key (e.g., "NEW")
  color     String   @default("bg-blue-500") // Tailwind color class
  order     Int      // Sort order (0, 1, 2, ...)
  isDefault Boolean  @default(false) // Is this the default stage for new leads?
  isWon     Boolean  @default(false) // Is this a "won" stage?
  isLost    Boolean  @default(false) // Is this a "lost" stage?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
